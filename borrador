import tkinter as tk
from tkinter import messagebox
from tkinter import ttk
import csv
from datetime import datetime

CITAS_FILE = 'citas.csv'
APP_TITLE = "Sistema de Gestión de Citas Médicas"
BG_COLOR = "#F0F4F8"
PRIMARY_COLOR = "#4A90E2"
ACCENT_COLOR = "#4CAF50"
DANGER_COLOR = "#E57373"
TEXT_COLOR = "#333333"

def guardar_cita(nombre, doctor_o_motivo, fecha, hora):
    with open(CITAS_FILE, 'a', newline='', encoding='utf-8') as f:
        escritor = csv.writer(f)
        escritor.writerow([nombre, doctor_o_motivo, fecha, hora])
    messagebox.showinfo("Cita Agendada", "¡La cita ha sido agendada con éxito!")
    limpiar_campos()

def limpiar_campos():
    entry_nombre.delete(0, tk.END)
    combobox_doctor_motivo.set('Selecciona o escribe el motivo...')
    entry_fecha.delete(0, tk.END)
    entry_hora.delete(0, tk.END)

def cargar_citas():
    try:
        with open(CITAS_FILE, 'r', encoding='utf-8') as f:
            lector = csv.reader(f)
            return list(lector)
    except FileNotFoundError:
        return []

def guardar_todas_las_citas(citas):
    with open(CITAS_FILE, 'w', newline='', encoding='utf-8') as f:
        escritor = csv.writer(f)
        escritor.writerows(citas)

def eliminar_cita_seleccionada(listbox_citas, ventana_citas):
    seleccion = listbox_citas.curselection()
    if not seleccion:
        messagebox.showwarning("Nada Seleccionado", "Por favor, elige una cita de la lista para eliminar.")
        return

    indice_a_eliminar = seleccion[0]
    
    if messagebox.askyesno("Confirmar Cancelación", "¿Estás seguro de que quieres cancelar esta cita? ¡Esta acción es irreversible!"):
        citas_existentes = cargar_citas()
        if 0 <= indice_a_eliminar < len(citas_existentes):
            del citas_existentes[indice_a_eliminar]
            guardar_todas_las_citas(citas_existentes)
            messagebox.showinfo("Cita Cancelada", "La cita ha sido cancelada satisfactoriamente.")
            ventana_citas.destroy()
            ver_citas()
        else:
            messagebox.showerror("Error Interno", "No se pudo encontrar la cita. Por favor, inténtalo de nuevo.")

def ver_citas():
    ventana_citas = tk.Toplevel(ventana)
    ventana_citas.title("Tus Citas Agendadas")
    ventana_citas.geometry("700x500")
    ventana_citas.resizable(True, True)
    ventana_citas.config(bg=BG_COLOR)

    citas = cargar_citas()

    if not citas:
        tk.Label(ventana_citas, text="¡Vaya! Parece que no tienes citas agendadas aún.", 
                 font=('Arial', 14, 'italic'), fg=TEXT_COLOR, bg=BG_COLOR).pack(pady=50, padx=20)
        return

    frame_list_container = tk.Frame(ventana_citas, bd=2, relief="groove", padx=5, pady=5, bg="white")
    frame_list_container.pack(pady=15, padx=20, fill=tk.BOTH, expand=True)

    scrollbar = ttk.Scrollbar(frame_list_container, orient=tk.VERTICAL)
    listbox_citas = tk.Listbox(frame_list_container, yscrollcommand=scrollbar.set, 
                               font=('Consolas', 11), selectmode=tk.SINGLE, 
                               bd=0, relief="flat", bg="white", fg=TEXT_COLOR,
                               selectbackground=PRIMARY_COLOR, selectforeground="white",
                               highlightbackground=PRIMARY_COLOR, highlightthickness=1)
    scrollbar.config(command=listbox_citas.yview)

    scrollbar.pack(side=tk.RIGHT, fill=tk.Y)
    listbox_citas.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)

    listbox_citas.insert(tk.END, f"{'Paciente':<20} {'Motivo/Doctor':<25} {'Fecha':<15} {'Hora':<10}")
    listbox_citas.insert(tk.END, "-"*70)
    
    for i, cita in enumerate(citas):
        listbox_citas.insert(tk.END, f"{cita[0]:<20} {cita[1]:<25} {cita[2]:<15} {cita[3]:<10}")
    
    ttk.Button(ventana_citas, text="Cancelar Cita Seleccionada", 
               command=lambda: eliminar_cita_seleccionada(listbox_citas, ventana_citas), 
               style="Danger.TButton").pack(pady=15)

def agendar():
    nombre = entry_nombre.get().strip()
    doctor_o_motivo = combobox_doctor_motivo.get().strip()
    fecha = entry_fecha.get().strip()
    hora = entry_hora.get().strip()

    if not nombre or not doctor_o_motivo or not fecha or not hora:
        messagebox.showwarning("Campos Requeridos", "¡Ups! Por favor, asegúrate de llenar todos los campos para agendar tu cita.")
        return

    try:
        datetime.strptime(fecha, "%d/%m/%Y")
    except ValueError:
        messagebox.showerror("Fecha Inválida", "El formato de la fecha es incorrecto. Usa DD/MM/AAAA (ej. 31/12/2025).")
        return

    try:
        datetime.strptime(hora, "%H:%M")
    except ValueError:
        messagebox.showerror("Hora Inválida", "El formato de la hora es incorrecto. Usa HH:MM (ej. 14:30).")
        return

    guardar_cita(nombre, doctor_o_motivo, fecha, hora)

ventana = tk.Tk()
ventana.title(APP_TITLE)
ventana.geometry("500x580")
ventana.resizable(False, False)
ventana.config(bg=BG_COLOR)

style = ttk.Style()
style.theme_use('clam')

style.configure("TLabel", font=('Arial', 12), foreground=TEXT_COLOR, background=BG_COLOR)
style.configure("TEntry", font=('Arial', 11), padding=5, fieldbackground="white", foreground=TEXT_COLOR)
style.configure("TCombobox", font=('Arial', 11), padding=5, fieldbackground="white", foreground=TEXT_COLOR)

style.configure("Primary.TButton", 
                font=('Arial', 12, 'bold'), 
                background=PRIMARY_COLOR, 
                foreground="white", 
                padding=(15, 10), 
                relief="flat")
style.map("Primary.TButton", 
          background=[('active', '#3A7EC2')], 
          foreground=[('active', 'white')])

style.configure("Danger.TButton", 
                font=('Arial', 11, 'bold'), 
                background=DANGER_COLOR, 
                foreground="white", 
                padding=(10, 8), 
                relief="flat")
style.map("Danger.TButton", 
          background=[('active', '#C25B5B')], 
          foreground=[('active', 'white')])

menubar = tk.Menu(ventana, tearoff=0)
ventana.config(menu=menubar)

opciones_menu = tk.Menu(menubar, tearoff=0)
menubar.add_cascade(label="Opciones", menu=opciones_menu)
opciones_menu.add_command(label="Agendar Nueva Cita", command=lambda: ventana.lift())
opciones_menu.add_command(label="Ver Citas Agendadas", command=ver_citas)
opciones_menu.add_separator()
opciones_menu.add_command(label="Salir", command=ventana.quit)

main_frame = tk.Frame(ventana, bg=BG_COLOR, padx=30, pady=20)
main_frame.pack(expand=True, fill="both")

tk.Label(main_frame, text="Agenda tu Próxima Cita Médica", 
         font=('Arial', 18, 'bold'), fg=PRIMARY_COLOR, bg=BG_COLOR).grid(row=0, column=0, columnspan=2, pady=(0, 25))

tk.Label(main_frame, text="Nombre del Paciente:", 
         font=('Arial', 12, 'bold'), fg=TEXT_COLOR, bg=BG_COLOR).grid(row=1, column=0, sticky="w", pady=(10, 2))
entry_nombre = ttk.Entry(main_frame)
entry_nombre.grid(row=2, column=0, columnspan=2, sticky="ew", padx=0, pady=(0, 15))

tk.Label(main_frame, text="Motivo de la Cita / Especialidad:", 
         font=('Arial', 12, 'bold'), fg=TEXT_COLOR, bg=BG_COLOR).grid(row=3, column=0, sticky="w", pady=(10, 2))
MOTIVOS_CITAS = [
    "Consulta General", "Odontología", "Pediatría", "Ginecología", "Cardiología",
    "Dermatología", "Oftalmología", "Otorrinolaringología", "Traumatología",
    "Psicología", "Nutrición", "Fisioterapia", "Revisión de Rutina",
    "Seguimiento de Tratamiento", "Vacunación", "Urgencia Menor", "Otro"
]
combobox_doctor_motivo = ttk.Combobox(main_frame, values=MOTIVOS_CITAS)
combobox_doctor_motivo.set("Selecciona o escribe el motivo...")
combobox_doctor_motivo.grid(row=4, column=0, columnspan=2, sticky="ew", padx=0, pady=(0, 15))

tk.Label(main_frame, text="Fecha de la Cita (DD/MM/AAAA):", 
         font=('Arial', 12, 'bold'), fg=TEXT_COLOR, bg=BG_COLOR).grid(row=5, column=0, sticky="w", pady=(10, 2))
entry_fecha = ttk.Entry(main_frame)
entry_fecha.grid(row=6, column=0, columnspan=2, sticky="ew", padx=0, pady=(0, 15))

tk.Label(main_frame, text="Hora de la Cita (HH:MM):", 
         font=('Arial', 12, 'bold'), fg=TEXT_COLOR, bg=BG_COLOR).grid(row=7, column=0, sticky="w", pady=(10, 2))
entry_hora = ttk.Entry(main_frame)
entry_hora.grid(row=8, column=0, columnspan=2, sticky="ew", padx=0, pady=(0, 25))

ttk.Button(main_frame, text="Agendar Nueva Cita", command=agendar, style="Primary.TButton").grid(row=9, column=0, columnspan=2, pady=10, sticky="ew")
ttk.Button(main_frame, text="Ver Todas las Citas", command=ver_citas, style="Primary.TButton").grid(row=10, column=0, columnspan=2, pady=5, sticky="ew")

main_frame.grid_columnconfigure(0, weight=1)
main_frame.grid_columnconfigure(1, weight=1)

ventana.mainloop()
